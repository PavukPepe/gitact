name: front-pipeline
on:
  push:
    branches:
      - main

jobs:
  install:
    name: Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup npm
        uses: actions/setup-node@v6
        with:
          node-version: 22
      
      - name: Install dependencies
        run: | 
          npm ci --cache .npm-cache --prefer-offline
          echo "Dependencies installed successfully"
    
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup npm
        uses: actions/setup-node@v6
        with:
          node-version: 22
      
      - name: Install dependencies
        run: npm ci --cache .npm-cache --prefer-offline

      - name: Run ESLint
        run: npm run lint:ci

      - name: Upload ESLint Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: eslint-report-${{ github.sha }}
          paths: eslint-report.json
          retention-days: 7

  typecheck:
    name: Type Check Code
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup npm
        uses: actions/setup-node@v6
        with:
          node-version: 22
      
      - name: Install dependencies
        run: npm ci --cache .npm-cache --prefer-offline

      - name: Run TypeScript Check
        run: npx tsc --noEmit

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup npm
        uses: actions/setup-node@v6
        with:
          node-version: 22
      
      - name: Install dependencies
        run: npm ci --cache .npm-cache --prefer-offline

      - name: Build Application
        run: npm run build
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: next-build-${{ github.sha }}
          paths: .next/
          exclude: .next/cache/**
          retention-days: 3

  audit:
    name: Audit Code
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup npm
        uses: actions/setup-node@v6
        with:
          node-version: 22
      
      - name: Install dependencies
        run: npm ci --cache .npm-cache --prefer-offline

      - name: Run npm audit
        run: npm audit --audit-level=high 2>&1 | tee audit-report.txt || true

  bundle_size:
    name: Check Bundle Size
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup npm
        uses: actions/setup-node@v6
        with:
          node-version: 22
      
      - name: Install dependencies
        run: npm ci --cache .npm-cache --prefer-offline

      - name: Check Bundle Size
        run: |
          echo "=== Next.js bundle size report ===" | tee bundle-report.txt
          du -sh .next/                             | tee -a bundle-report.txt
          echo ""                                   | tee -a bundle-report.txt
          echo "--- Static pages ---"              | tee -a bundle-report.txt
          du -sh .next/static/     2>/dev/null     | tee -a bundle-report.txt
          echo ""                                   | tee -a bundle-report.txt
          echo "--- Chunks (top 10 by size) ---"   | tee -a bundle-report.txt
          find .next/static/chunks -name "*.js" \
            -exec du -sh {} \; 2>/dev/null \
            | sort -rh | head -10                  | tee -a bundle-report.txt


